<!--
  exercise-generator-modal.component.html

  Modal de g√©n√©ration d'exercices avec IA.

  Structure :
  ==========
  1. Overlay sombre (ferme au clic)
  2. Container du modal
     - Header avec titre et bouton fermer
     - Warning Ollama si non disponible
     - Formulaire de configuration OU
     - √âtat de chargement OU
     - Aper√ßu de l'exercice g√©n√©r√©
     - Message d'erreur si √©chec

  Auteur: H1m0t3p3
  Date: 25 d√©cembre 2024
-->

<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">

    <!-- ========================================== -->
    <!-- HEADER -->
    <!-- ========================================== -->
    <header class="modal-header">
      <div class="header-title">
        <span class="header-icon">ü§ñ</span>
        <div>
          <h2>G√©n√©rateur d'exercices IA</h2>
          <p class="header-subtitle" *ngIf="isOllamaAvailable && modelName">
            Propuls√© par {{ modelName.split(':')[0] }}
          </p>
        </div>
      </div>
      <button class="close-btn" (click)="closeModal()" aria-label="Fermer">
        <span>‚úï</span>
      </button>
    </header>

    <!-- ========================================== -->
    <!-- WARNING OLLAMA NON DISPONIBLE -->
    <!-- ========================================== -->
    <div class="ollama-warning" *ngIf="!isOllamaAvailable && status !== 'checking'">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <div class="warning-content">
        <h3>Ollama non disponible</h3>
        <p>Pour utiliser le g√©n√©rateur IA, lancez Ollama dans un terminal :</p>
        <code>ollama serve</code>
        <button class="btn-refresh" (click)="refreshOllamaStatus()">
          üîÑ R√©essayer
        </button>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- FORMULAIRE DE CONFIGURATION -->
    <!-- ========================================== -->
    <form class="config-form" *ngIf="isOllamaAvailable && !generatedExercise && status !== 'generating'">

      <!-- Type d'exercice -->
      <div class="form-group">
        <label class="form-label">Sujet</label>
        <div class="type-grid">
          <button
            *ngFor="let type of exerciseTypes"
            type="button"
            class="type-btn"
            [class.selected]="selectedType === type.value"
            (click)="selectedType = type.value">
            <span class="type-icon">{{ type.icon }}</span>
            <span class="type-label">{{ type.label }}</span>
          </button>
        </div>
      </div>

      <!-- Difficult√© -->
      <div class="form-group">
        <label class="form-label">Difficult√©</label>
        <div class="difficulty-btns">
          <button
            *ngFor="let diff of difficulties"
            type="button"
            class="difficulty-btn"
            [class.selected]="selectedDifficulty === diff.value"
            [style.--diff-color]="diff.color"
            (click)="selectedDifficulty = diff.value">
            {{ diff.label }}
          </button>
        </div>
      </div>

      <!-- Format -->
      <div class="form-group">
        <label class="form-label">Format de l'exercice</label>
        <div class="format-grid">
          <button
            *ngFor="let format of formats"
            type="button"
            class="format-btn"
            [class.selected]="selectedFormat === format.value"
            (click)="selectedFormat = format.value">
            <span class="format-icon">{{ format.icon }}</span>
            <span class="format-label">{{ format.label }}</span>
            <span class="format-desc">{{ format.description }}</span>
          </button>
        </div>
      </div>

      <!-- Options -->
      <div class="form-group options-group">
        <label class="toggle-label">
          <input type="checkbox" [(ngModel)]="includeSolution" name="includeSolution">
          <span class="toggle-text">Inclure la solution</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" [(ngModel)]="includeHints" name="includeHints">
          <span class="toggle-text">Inclure des indices</span>
        </label>
      </div>

      <!-- Bouton G√©n√©rer -->
      <button
        type="button"
        class="btn-generate"
        (click)="generateExercise()"
        [disabled]="!isOllamaAvailable">
        <span class="btn-icon">‚ú®</span>
        <span>G√©n√©rer un exercice</span>
      </button>

    </form>

    <!-- ========================================== -->
    <!-- √âTAT DE CHARGEMENT -->
    <!-- ========================================== -->
    <div class="loading-state" *ngIf="status === 'generating' || status === 'checking'">
      <div class="spinner"></div>
      <p class="loading-text">
        {{ status === 'checking' ? 'Connexion √† Ollama...' : 'G√©n√©ration en cours...' }}
      </p>
      <p class="loading-hint">
        {{ status === 'checking' ? 'V√©rification du mod√®le IA' : 'L\'IA r√©fl√©chit √† ton exercice' }}
      </p>
    </div>

    <!-- ========================================== -->
    <!-- APER√áU DE L'EXERCICE G√âN√âR√â -->
    <!-- ========================================== -->
    <div class="preview-section" *ngIf="generatedExercise && status === 'success'">

      <!-- Badge de succ√®s -->
      <div class="generation-badge">
        <span class="badge-icon">‚úì</span>
        <span>Exercice g√©n√©r√© en {{ formatGenerationTime() }}</span>
      </div>

      <!-- Aper√ßu -->
      <div class="exercise-preview">
        <h3 class="preview-title">{{ generatedExercise.title }}</h3>

        <div class="preview-meta">
          <span class="meta-tag type">{{ selectedType }}</span>
          <span class="meta-tag difficulty" [attr.data-diff]="selectedDifficulty">
            {{ selectedDifficulty }}
          </span>
          <span class="meta-tag format">{{ selectedFormat }}</span>
        </div>

        <div class="preview-description">
          <h4>√ânonc√©</h4>
          <p>{{ generatedExercise.description }}</p>
        </div>

        <!-- Options QCM -->
        <div class="preview-options" *ngIf="generatedExercise.options">
          <h4>Options</h4>
          <ul class="options-list">
            <li *ngFor="let opt of generatedExercise.options; let i = index"
                [class.correct]="opt.isCorrect">
              <span class="option-letter">{{ ['A', 'B', 'C', 'D'][i] }})</span>
              {{ opt.text }}
              <span class="correct-badge" *ngIf="opt.isCorrect">‚úì</span>
            </li>
          </ul>
        </div>

        <!-- Code Snippet -->
        <div class="preview-code" *ngIf="generatedExercise.codeSnippet">
          <h4>Code</h4>
          <pre><code>{{ generatedExercise.codeSnippet }}</code></pre>
        </div>

        <!-- Indices -->
        <details class="preview-hints" *ngIf="generatedExercise.hints?.length">
          <summary>üí° Indices ({{ generatedExercise.hints?.length }})</summary>
          <ol>
            <li *ngFor="let hint of generatedExercise.hints">{{ hint }}</li>
          </ol>
        </details>

        <!-- Solution -->
        <details class="preview-solution" *ngIf="generatedExercise.solution">
          <summary>üîë Solution</summary>
          <div class="solution-content">
            <div *ngIf="generatedExercise.solution.pseudoCode">
              <h5>Pseudo-code</h5>
              <pre>{{ generatedExercise.solution.pseudoCode }}</pre>
            </div>
            <div *ngIf="generatedExercise.solution.javaCode">
              <h5>Java</h5>
              <pre><code>{{ generatedExercise.solution.javaCode }}</code></pre>
            </div>
            <div *ngIf="generatedExercise.solution.explanation">
              <h5>Explication</h5>
              <p>{{ generatedExercise.solution.explanation }}</p>
            </div>
          </div>
        </details>
      </div>

      <!-- Actions -->
      <div class="preview-actions">
        <button class="btn-back" (click)="backToForm()">
          ‚Üê Modifier
        </button>
        <button class="btn-regenerate" (click)="regenerate()">
          üîÑ R√©g√©n√©rer
        </button>
        <button class="btn-save" (click)="saveExercise()" [disabled]="isSaving">
          {{ isSaving ? 'Sauvegarde...' : 'üíæ Sauvegarder' }}
        </button>
      </div>

    </div>

    <!-- ========================================== -->
    <!-- MESSAGE D'ERREUR -->
    <!-- ========================================== -->
    <div class="error-state" *ngIf="errorMessage && status === 'error'">
      <div class="error-icon">‚ùå</div>
      <p class="error-text">{{ errorMessage }}</p>
      <div class="error-actions">
        <button class="btn-back" (click)="backToForm()">
          ‚Üê Modifier les param√®tres
        </button>
        <button class="btn-retry" (click)="generateExercise()">
          üîÑ R√©essayer
        </button>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- SUCC√àS DE SAUVEGARDE -->
    <!-- ========================================== -->
    <div class="success-overlay" *ngIf="showSuccess">
      <div class="success-content">
        <span class="success-icon">‚úì</span>
        <h3>Exercice sauvegard√© !</h3>
        <p>+{{ calculateXP() }} XP</p>
      </div>
    </div>

  </div>
</div>
